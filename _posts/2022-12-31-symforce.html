---
layout: notebook
title: Symforce
description: Symforce basics
tag: Notebook
---

<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h2 id="Introduction">
    Introduction
    <a class="anchor-link" href="#Introduction">
     ¶
    </a>
   </h2>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    <a href="https://symforce.org/">
     SymForce
    </a>
    is a fast symbolic computation and code generation library for robotics applications like computer vision, state estimation, motion planning, and controls. It combines the development speed and flexibility of symbolic mathematics with the performance of autogenerated, highly optimized code in C++ or any target runtime language. SymForce contains three independently useful systems:
   </p>
   <p>
    <strong>
     Symbolic Toolkit
    </strong>
    - builds on the SymPy API to provide rigorous geometric and camera types, lie group calculus, singularity handling, and tools to model complex problems
   </p>
   <p>
    <strong>
     Code Generator
    </strong>
    - transforms symbolic expressions into blazing-fast, branchless code with clean APIs and minimal dependencies, with a template system to target any language
   </p>
   <p>
    <strong>
     Optimization Library
    </strong>
    - a fast tangent-space optimization library based on factor graphs, with a highly optimized implementation for real-time robotics applications
   </p>
   <p>
    SymForce automatically computes tangent space Jacobians, eliminating the need for any bug-prone handwritten derivatives. Generated functions can be directly used as factors in our nonlinear optimizer. This workflow enables faster runtime functions, faster development time, and fewer lines of handwritten code versus alternative methods.
   </p>
   <p>
    SymForce is developed and maintained by
    <strong>
     Skydio
    </strong>
    . It is used in production to accelerate tasks like SLAM, bundle adjustment, calibration, and sparse nonlinear MPC for autonomous robots at scale.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h2 id="Tutorials">
    Tutorials
    <a class="anchor-link" href="#Tutorials">
     ¶
    </a>
   </h2>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [1]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Import symforce</span>
<span class="kn">import</span> <span class="nn">symforce</span>

<span class="n">symforce</span><span class="o">.</span><span class="n">set_symbolic_api</span><span class="p">(</span><span class="s2">"sympy"</span><span class="p">)</span>
<span class="n">symforce</span><span class="o">.</span><span class="n">set_log_level</span><span class="p">(</span><span class="s2">"warning"</span><span class="p">)</span>
<span class="n">symforce</span><span class="o">.</span><span class="n">set_epsilon_to_symbol</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display</span>

<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Geo-Package">
    Geo Package
    <a class="anchor-link" href="#Geo-Package">
     ¶
    </a>
   </h3>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Matrix">
    Matrix
    <a class="anchor-link" href="#Matrix">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [2]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Define matrix</span>
<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display</span>

<span class="c1"># Construction from 2D list</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Construction using specified size + data</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">m2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Construction from 2D list</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Construction from 1D list. We assume a 1D list represents a column vector.</span>
<span class="n">v2</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Construction using aliases (defined by default for 9x1 vectors and smaller)</span>
<span class="n">v3</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">v3</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">zero_matrix</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix33</span><span class="o">.</span><span class="n">zero</span><span class="p">()</span>
<span class="n">identity_matrix</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix33</span><span class="o">.</span><span class="n">eye</span><span class="p">()</span>

<span class="n">zero_matrix</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">identity_matrix</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_stream output_stdout output_text">
     <pre>(2, 3)
(2, 3)
(3, 1)
(3, 1)
(3, 1)
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Rotations">
    Rotations
    <a class="anchor-link" href="#Rotations">
     ¶
    </a>
   </h4>
   <p>
    Quaternion is used as the underlying representation.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [3]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Define rotations</span>

<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display</span>

<span class="c1"># Identity definition</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>

<span class="c1"># Symbolic definition</span>
<span class="n">R_sym</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_sym</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_sym</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">())</span>

<span class="c1"># Symbolic definition</span>
<span class="n">Q_sym</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Quaternion</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"Q"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">Q_sym</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Rot3 &lt;Q xyzw=[0, 0, 0, 1]&gt;&gt;</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}1 &amp; 0 &amp; 0\\0 &amp; 1 &amp; 0\\0 &amp; 0 &amp; 1\end{matrix}\right]$
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>array([[1., 0., 0.],
       [0., 1., 0.],
       [0., 0., 1.]])</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Rot3 &lt;Q xyzw=[R_x, R_y, R_z, R_w]&gt;&gt;</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}- 2 R_{y}^{2} - 2 R_{z}^{2} + 1 &amp; - 2 R_{w} R_{z} + 2 R_{x} R_{y} &amp; 2 R_{w} R_{y} + 2 R_{x} R_{z}\\2 R_{w} R_{z} + 2 R_{x} R_{y} &amp; - 2 R_{x}^{2} - 2 R_{z}^{2} + 1 &amp; - 2 R_{w} R_{x} + 2 R_{y} R_{z}\\- 2 R_{w} R_{y} + 2 R_{x} R_{z} &amp; 2 R_{w} R_{x} + 2 R_{y} R_{z} &amp; - 2 R_{x}^{2} - 2 R_{y}^{2} + 1\end{matrix}\right]$
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Q xyzw=[Q_x, Q_y, Q_z, Q_w]&gt;</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="symforce.symbolic.Pose3-and--sym.Pose3">
    symforce.symbolic.Pose3 and  sym.Pose3
    <a class="anchor-link" href="#symforce.symbolic.Pose3-and--sym.Pose3">
     ¶
    </a>
   </h4>
   <p>
    SymForce provides
    <strong>
     sym
    </strong>
    packages with
    <strong>
     runtime code
    </strong>
    for geometry and camera types, e.g.
    <code>
     sym.Pose3
    </code>
    that are generated from its
    <strong>
     symbolic geo and cam packages
    </strong>
    , e.g.
    <code>
     symforce.symbolic.Pose3
    </code>
    . As such, there are multiple versions of a class like Pose3 and it can be a common source of confusion.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [4]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># symforce.symbolic</span>
<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">(</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">w</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Pose3 R=&lt;Rot3 &lt;Q xyzw=[0, 0, 0, 1.0]&gt;&gt;, t=(0, 0, 0)&gt;</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [5]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># sym runtime code</span>
<span class="kn">import</span> <span class="nn">sym</span>
<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"sym package rotation matrix type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sym</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"symbolic package rotation matrix type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"symbolic package rotation matrix to_numpy type: </span><span class="si">{</span> <span class="nb">type</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_stream output_stdout output_text">
     <pre>sym package rotation matrix type: &lt;class 'numpy.ndarray'&gt;
symbolic package rotation matrix type: &lt;class 'symforce.geo.matrix.Matrix33'&gt;
symbolic package rotation matrix to_numpy type: &lt;class 'numpy.ndarray'&gt;
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [6]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># k3d plot helper</span>

<span class="kn">import</span> <span class="nn">k3d</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># TODO(xipeng.wang): Update this to use symforce directly instead of numpy</span>
<span class="k">class</span> <span class="nc">XYZ_RBG_Axes</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xffff00</span><span class="p">,</span> <span class="n">axis_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_length</span> <span class="o">=</span> <span class="n">axis_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">z_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xline_plot</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">shader</span><span class="o">=</span><span class="s1">'mesh'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff0000</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">'_xaxis'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yline_plot</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">y_axis</span><span class="p">,</span> <span class="n">shader</span><span class="o">=</span><span class="s1">'mesh'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x0000ff</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">'_yaxis'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zline_plot</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">z_axis</span><span class="p">,</span> <span class="n">shader</span><span class="o">=</span><span class="s1">'mesh'</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x00ff00</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">'_zaxis'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpoint</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">point_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                  <span class="n">shader</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">'_end_point_x'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypoint</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">point_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                  <span class="n">shader</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">'_end_point_y'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zpoint</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">point_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                  <span class="n">shader</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">'_end_point_z'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xline_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yline_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zline_plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ypoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zpoint</span> 
    <span class="k">def</span> <span class="nf">update_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="n">axis_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_length</span>
        <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">y_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">z_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">origin</span><span class="p">,</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xline_plot</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">x_axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xpoint</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yline_plot</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">y_axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ypoint</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zline_plot</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">z_axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zpoint</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">origin</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">axis_length</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># k3d plot example</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">k3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">camera_auto_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="p">()</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">C0</span> <span class="o">=</span> <span class="n">XYZ_RBG_Axes</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="s1">'C0'</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">.</span><span class="n">to_rotation_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">C1</span> <span class="o">=</span> <span class="n">XYZ_RBG_Axes</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="s1">'C1'</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

<span class="n">plot</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Values">
    Values
    <a class="anchor-link" href="#Values">
     ¶
    </a>
   </h3>
   <p>
    Values objects are ordered dict-like containers used to store multiple heterogeneous objects, normally for the purpose of function generation.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [8]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Create Values</span>

<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">symforce.values</span> <span class="kn">import</span> <span class="n">Values</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">inputs</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"x"</span><span class="p">),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"z"</span><span class="p">))</span>

<span class="n">time</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">"h"</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"h"</span><span class="p">),</span>
     <span class="s2">"m"</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"m"</span><span class="p">),</span>
     <span class="s2">"s"</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"s"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">timezone</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span><span class="n">time_zone</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">))</span>
<span class="c1"># time["t"] =  time</span>
<span class="n">inputs</span><span class="p">[</span><span class="s2">"t"</span><span class="p">]</span> <span class="o">=</span>  <span class="n">time</span>
<span class="n">time</span><span class="p">[</span><span class="s2">"timezone"</span><span class="p">]</span> <span class="o">=</span>  <span class="n">timezone</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">"id"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

<span class="c1"># A Values serializes to a depth-first traversed list.</span>
<span class="c1"># display(inputs.to_storage())</span>

<span class="n">display</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">items_recursive</span><span class="p">())</span>
<span class="c1"># display(inputs.keys_recursive())</span>
<span class="c1"># display(inputs.values_recursive())</span>

<span class="c1"># Index describes which parts of the serialized list correspond to which types. </span>
<span class="c1"># The spec is T.Dict[str, IndexEntry] where IndexEntry has attributes </span>
<span class="c1"># offset, storage_dim, datatype, shape, item_index</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
<span class="n">reconstructed_inputs</span> <span class="o">=</span> <span class="n">Values</span><span class="o">.</span><span class="n">from_storage_index</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">to_storage</span><span class="p">(),</span> <span class="n">index</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">inputs</span> <span class="o">==</span> <span class="n">reconstructed_inputs</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Before modifying id: </span><span class="si">{</span><span class="n">inputs</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
<span class="n">inputs</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'After modifying id: </span><span class="si">{</span><span class="n">inputs</span><span class="p">[</span><span class="s2">"id"</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>Values(
  x: x,
  y: y,
  z: z,
  t:   Values(
    h: h,
    m: m,
    s: s,
    timezone:     Values(
      time_zone: zone,
    ),
  ),
  id: id,
)</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>[('x', x),
 ('y', y),
 ('z', z),
 ('t.h', h),
 ('t.m', m),
 ('t.s', s),
 ('t.timezone.time_zone', zone),
 ('id', id)]</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_stream output_stdout output_text">
     <pre>Before modifying id: id
After modifying id: 1024
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [9]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Use scope to add sub-values</span>
<span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">scope</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">):</span>
    <span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"x"</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">sf</span><span class="o">.</span><span class="n">scope</span><span class="p">(</span><span class="s2">"bar"</span><span class="p">):</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"x"</span><span class="p">))</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"y"</span><span class="p">))</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"z"</span><span class="p">)</span>
<span class="c1"># This attr can also be used to add new values</span>
<span class="n">inputs</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">foo</span><span class="o">.</span><span class="n">bar</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="k">with</span> <span class="n">inputs</span><span class="o">.</span><span class="n">scope</span><span class="p">(</span><span class="s2">"foo2"</span><span class="p">):</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">"x"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"x"</span><span class="p">)</span>
<span class="k">with</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">"foo2"</span><span class="p">]</span><span class="o">.</span><span class="n">scope</span><span class="p">(</span><span class="s2">"bar2"</span><span class="p">):</span>
    <span class="n">inputs</span><span class="p">[</span><span class="s2">"foo2"</span><span class="p">][</span><span class="s2">"x"</span><span class="p">]</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"x"</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">items_recursive</span><span class="p">())</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>Values(
  x: x,
  y: y,
  z: z,
  t:   Values(
    h: h,
    m: m,
    s: s,
    timezone:     Values(
      time_zone: zone,
    ),
  ),
  id: 1024,
  foo:   Values(
    x: foo.x,
    bar:     Values(
      x: 1024,
      y: foo.bar.y,
      z: z,
    ),
  ),
  foo2:   Values(
    x: foo2.x,
    bar2:     Values(
      x: bar2.x,
    ),
  ),
)</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>[('x', x),
 ('y', y),
 ('z', z),
 ('t.h', h),
 ('t.m', m),
 ('t.s', s),
 ('t.timezone.time_zone', zone),
 ('id', 1024),
 ('foo.x', foo.x),
 ('foo.bar.x', 1024),
 ('foo.bar.y', foo.bar.y),
 ('foo.bar.z', z),
 ('foo2.x', foo2.x),
 ('foo2.bar2.x', bar2.x)]</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [10]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Values contains a list</span>

<span class="n">initial_values</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="c1"># Values key will be distances[0], distances[1]</span>
    <span class="n">distances</span><span class="o">=</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">V2</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"t"</span><span class="p">),</span> <span class="n">sf</span><span class="o">.</span><span class="n">V2</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"t"</span><span class="p">)],</span>
    <span class="n">epsilon</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">numeric_epsilon</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">initial_values</span><span class="o">.</span><span class="n">items_recursive</span><span class="p">())</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>[('distances[0]',
  Matrix([
  [t0],
  [t1]])),
 ('distances[1]',
  Matrix([
  [t0],
  [t1]])),
 ('epsilon', 2.220446049250313e-15)]</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [11]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Group Ops on values</span>
<span class="n">w_T_b</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="n">T</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"T"</span><span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tangent dim: </span><span class="si">{</span><span class="n">w_T_b</span><span class="o">.</span><span class="n">tangent_dim</span><span class="p">()</span><span class="si">}</span><span class="s2">, storage dim: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">w_T_b</span><span class="o">.</span><span class="n">to_storage</span><span class="p">())</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"storage_D_tangent shape: </span><span class="si">{</span><span class="n">w_T_b</span><span class="o">.</span><span class="n">storage_D_tangent</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="c1"># display(pose.to_tangent())</span>
<span class="n">p_w</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"w"</span><span class="p">)</span>
<span class="n">p_b</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span>
<span class="n">residual</span> <span class="o">=</span> <span class="n">w_T_b</span><span class="p">[</span><span class="s2">"T"</span><span class="p">]</span> <span class="o">*</span> <span class="n">p_b</span> <span class="o">-</span> <span class="n">p_w</span>
<span class="n">residual_D_tangent</span> <span class="o">=</span> <span class="n">residual</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">w_T_b</span><span class="p">[</span><span class="s2">"T"</span><span class="p">])</span>
<span class="n">display</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">residual_D_tangent</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">residual_D_tangent</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_stream output_stdout output_text">
     <pre>tangent dim: 6, storage dim: 7
storage_D_tangent shape: (7, 6)
</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}T.t0 + b_{0} \left(- 2 T.R_{y}^{2} - 2 T.R_{z}^{2} + 1\right) + b_{1} \left(- 2 T.R_{w} T.R_{z} + 2 T.R_{x} T.R_{y}\right) + b_{2} \cdot \left(2 T.R_{w} T.R_{y} + 2 T.R_{x} T.R_{z}\right) - w_{0}\\T.t1 + b_{0} \cdot \left(2 T.R_{w} T.R_{z} + 2 T.R_{x} T.R_{y}\right) + b_{1} \left(- 2 T.R_{x}^{2} - 2 T.R_{z}^{2} + 1\right) + b_{2} \left(- 2 T.R_{w} T.R_{x} + 2 T.R_{y} T.R_{z}\right) - w_{1}\\T.t2 + b_{0} \left(- 2 T.R_{w} T.R_{y} + 2 T.R_{x} T.R_{z}\right) + b_{1} \cdot \left(2 T.R_{w} T.R_{x} + 2 T.R_{y} T.R_{z}\right) + b_{2} \left(- 2 T.R_{x}^{2} - 2 T.R_{y}^{2} + 1\right) - w_{2}\end{matrix}\right]$
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left( 3, \  6\right)$
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}b_{1} \cdot \left(2 T.R_{w} T.R_{y} + 2 T.R_{x} T.R_{z}\right) + b_{2} \cdot \left(2 T.R_{w} T.R_{z} - 2 T.R_{x} T.R_{y}\right) &amp; b_{0} \left(- 2 T.R_{w} T.R_{y} - 2 T.R_{x} T.R_{z}\right) + b_{2} \left(T.R_{w}^{2} + T.R_{x}^{2} - T.R_{y}^{2} - T.R_{z}^{2}\right) &amp; b_{0} \left(- 2 T.R_{w} T.R_{z} + 2 T.R_{x} T.R_{y}\right) + b_{1} \left(- T.R_{w}^{2} - T.R_{x}^{2} + T.R_{y}^{2} + T.R_{z}^{2}\right) &amp; 1 &amp; 0 &amp; 0\\b_{1} \left(- 2 T.R_{w} T.R_{x} + 2 T.R_{y} T.R_{z}\right) + b_{2} \left(- T.R_{w}^{2} + T.R_{x}^{2} - T.R_{y}^{2} + T.R_{z}^{2}\right) &amp; b_{0} \cdot \left(2 T.R_{w} T.R_{x} - 2 T.R_{y} T.R_{z}\right) + b_{2} \cdot \left(2 T.R_{w} T.R_{z} + 2 T.R_{x} T.R_{y}\right) &amp; b_{0} \left(T.R_{w}^{2} - T.R_{x}^{2} + T.R_{y}^{2} - T.R_{z}^{2}\right) + b_{1} \left(- 2 T.R_{w} T.R_{z} - 2 T.R_{x} T.R_{y}\right) &amp; 0 &amp; 1 &amp; 0\\b_{1} \left(T.R_{w}^{2} - T.R_{x}^{2} - T.R_{y}^{2} + T.R_{z}^{2}\right) + b_{2} \left(- 2 T.R_{w} T.R_{x} - 2 T.R_{y} T.R_{z}\right) &amp; b_{0} \left(- T.R_{w}^{2} + T.R_{x}^{2} + T.R_{y}^{2} - T.R_{z}^{2}\right) + b_{2} \left(- 2 T.R_{w} T.R_{y} + 2 T.R_{x} T.R_{z}\right) &amp; b_{0} \cdot \left(2 T.R_{w} T.R_{x} + 2 T.R_{y} T.R_{z}\right) + b_{1} \cdot \left(2 T.R_{w} T.R_{y} - 2 T.R_{x} T.R_{z}\right) &amp; 0 &amp; 0 &amp; 1\end{matrix}\right]$
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Ops-Package">
    Ops Package
    <a class="anchor-link" href="#Ops-Package">
     ¶
    </a>
   </h3>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Storage-Ops">
    Storage Ops
    <a class="anchor-link" href="#Storage-Ops">
     ¶
    </a>
   </h4>
   <p>
    Data type that can be serialized to and from a vector of scalar quantities.
    <code>
     .storage_dim()
    </code>
    ,
    <code>
     .to_storage()
    </code>
    ,
    <code>
     .from_storage()
    </code>
    ,
    <code>
     .symbolic()
    </code>
    ,
    <code>
     .evalf()
    </code>
    ,
    <code>
     .subs()
    </code>
    ,
    <code>
     .simplify()
    </code>
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [12]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Storage Ops</span>

<span class="kn">from</span> <span class="nn">symforce.ops</span> <span class="kn">import</span> <span class="n">StorageOps</span>

<span class="c1"># Element-wise operations on Values object with multiple types of elements</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="n">pose</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">(),</span>
    <span class="n">scalar</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Symbol</span><span class="p">(</span><span class="s2">"x"</span><span class="p">),</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Storage dim: </span><span class="si">{</span><span class="n">StorageOps</span><span class="o">.</span><span class="n">storage_dim</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>  <span class="c1"># 4 quaternion + 3 position + 1 scalar</span>

<span class="c1"># Serialize geometric type and reconstruct</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"T"</span><span class="p">)</span>
<span class="n">T_serialized</span> <span class="o">=</span> <span class="n">StorageOps</span><span class="o">.</span><span class="n">to_storage</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">T_recovered</span> <span class="o">=</span> <span class="n">StorageOps</span><span class="o">.</span><span class="n">from_storage</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> <span class="n">T_serialized</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">T_serialized</span><span class="p">)</span>
<span class="k">assert</span><span class="p">(</span><span class="n">T</span> <span class="o">==</span> <span class="n">T_recovered</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_stream output_stdout output_text">
     <pre>Storage dim: 8
</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[ T.R_{x}, \  T.R_{y}, \  T.R_{z}, \  T.R_{w}, \  T.t0, \  T.t1, \  T.t2\right]$
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Group-Ops">
    Group Ops
    <a class="anchor-link" href="#Group-Ops">
     ¶
    </a>
   </h4>
   <p>
    Mathematical group that implements closure, associativity, identity and invertibility.
Methods:
    <code>
     .identity()
    </code>
    ,
    <code>
     .inverse()
    </code>
    ,
    <code>
     .compose()
    </code>
    ,
    <code>
     .between()
    </code>
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [13]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Group Ops</span>
<span class="kn">from</span> <span class="nn">symforce.ops</span> <span class="kn">import</span> <span class="n">GroupOps</span>
<span class="c1"># Identity of a pose</span>
<span class="n">w_T_b</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">GroupOps</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">w_T_b</span><span class="p">))</span>
<span class="c1"># Inverse of a vector</span>
<span class="n">p_b</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">GroupOps</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">p_b</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># Compose a pose and a point (wrong, they are not the same group)</span>
<span class="n">p_w</span> <span class="o">=</span> <span class="n">w_T_b</span> <span class="o">*</span> <span class="n">p_b</span> <span class="c1"># GroupOps.compose(w_T_b, p_b)</span>
<span class="c1"># display(p_w)</span>
<span class="n">display</span><span class="p">(</span><span class="n">GroupOps</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">p_b</span><span class="p">,</span> <span class="n">GroupOps</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="n">p_b</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Pose3 R=&lt;Rot3 &lt;Q xyzw=[0, 0, 0, 1]&gt;&gt;, t=(0, 0, 0)&gt;</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}-1 &amp; -1 &amp; -1\end{matrix}\right]$
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}0 &amp; 0 &amp; 0\end{matrix}\right]$
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [14]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Relative rotation -&gt; b1_R_b2 = GroupOps.between(w_R_b1, w_R_b2)</span>
<span class="n">w_R_b1</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span>
    <span class="n">angle</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
    <span class="n">axis</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">w_R_b2</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span>
    <span class="n">angle</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span>
    <span class="n">axis</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">b1_R_b2</span> <span class="o">=</span> <span class="n">GroupOps</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">w_R_b1</span><span class="p">,</span> <span class="n">w_R_b2</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">w_R_b2</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">GroupOps</span><span class="o">.</span><span class="n">simplify</span><span class="p">(</span><span class="n">GroupOps</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">w_R_b1</span><span class="p">,</span> <span class="n">b1_R_b2</span><span class="p">)))</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Rot3 &lt;Q xyzw=[0.00499791692706783*sqrt(10), 0, 0.0149937507812035*sqrt(10), 0.998750260394966]&gt;&gt;</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_text output_subarea">
     <pre>&lt;Rot3 &lt;Q xyzw=[0.00499791692706783*sqrt(10), 0, 0.0149937507812035*sqrt(10), 0.998750260394966]&gt;&gt;</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Lie-Group-Ops">
    Lie Group Ops
    <a class="anchor-link" href="#Lie-Group-Ops">
     ¶
    </a>
   </h4>
   <p>
    Group that is also a differentiable manifold, e.g. SO3, SE3.
Methods:
    <code>
     .tangent_dim()
    </code>
    ,
    <code>
     .from_tangent()
    </code>
    ,
    <code>
     to_tangent()
    </code>
    ,
    <code>
     .retract()
    </code>
    ,
    <code>
     .local_coordinates()
    </code>
    ,
    <code>
     .storage_D_tangent()
    </code>
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [15]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Lie Group Ops: basics</span>
<span class="kn">from</span> <span class="nn">symforce.ops</span> <span class="kn">import</span> <span class="n">LieGroupOps</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s1">'theta'</span><span class="p">)</span>
<span class="c1"># Underlying dimension of a 3D rotation's tangent space</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"3D rotation tangent space: </span><span class="si">{</span><span class="n">LieGroupOps</span><span class="o">.</span><span class="n">tangent_dim</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">R_tangent</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="n">LieGroupOps</span><span class="o">.</span><span class="n">to_tangent</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_tangent</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">R_reconstruct_</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_angle_axis</span><span class="p">(</span><span class="n">R_tangent</span><span class="o">.</span><span class="n">norm</span><span class="p">(),</span> <span class="n">R_tangent</span><span class="o">.</span><span class="n">normalized</span><span class="p">())</span>
<span class="n">R_reconstruct</span> <span class="o">=</span> <span class="n">LieGroupOps</span><span class="o">.</span><span class="n">from_tangent</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="p">,</span> <span class="n">R_tangent</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">R_reconstruct_</span> <span class="o">==</span> <span class="n">R_reconstruct</span>
</pre>
    </div>
   </div>
  </div>
 </div>
 <div class="output_wrapper">
  <div class="output">
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_stream output_stdout output_text">
     <pre>3D rotation tangent space: 3
</pre>
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_latex output_subarea">
     $\displaystyle \left[\begin{matrix}\frac{2 \theta_{x} \left(2 \min\left(0, \operatorname{sign}{\left(\theta_{w} \right)}\right) + 1\right) \operatorname{acos}{\left(\min\left(1 - \epsilon, \left|{\theta_{w}}\right|\right) \right)}}{\sqrt{1 - \min\left(1 - \epsilon, \left|{\theta_{w}}\right|\right)^{2}}} &amp; \frac{2 \theta_{y} \left(2 \min\left(0, \operatorname{sign}{\left(\theta_{w} \right)}\right) + 1\right) \operatorname{acos}{\left(\min\left(1 - \epsilon, \left|{\theta_{w}}\right|\right) \right)}}{\sqrt{1 - \min\left(1 - \epsilon, \left|{\theta_{w}}\right|\right)^{2}}} &amp; \frac{2 \theta_{z} \left(2 \min\left(0, \operatorname{sign}{\left(\theta_{w} \right)}\right) + 1\right) \operatorname{acos}{\left(\min\left(1 - \epsilon, \left|{\theta_{w}}\right|\right) \right)}}{\sqrt{1 - \min\left(1 - \epsilon, \left|{\theta_{w}}\right|\right)^{2}}}\end{matrix}\right]$
    </div>
   </div>
   <div class="output_area">
    <div class="prompt">
    </div>
    <div class="output_subarea output_text output_error">
     <pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AssertionError</span>                            Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[15], line 10</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span> R_reconstruct_ <span style="color: rgb(98,98,98)">=</span> sf<span style="color: rgb(98,98,98)">.</span>Rot3<span style="color: rgb(98,98,98)">.</span>from_angle_axis(R_tangent<span style="color: rgb(98,98,98)">.</span>norm(), R_tangent<span style="color: rgb(98,98,98)">.</span>normalized())
<span class="ansi-green-intense-fg ansi-bold">      9</span> R_reconstruct <span style="color: rgb(98,98,98)">=</span> LieGroupOps<span style="color: rgb(98,98,98)">.</span>from_tangent(sf<span style="color: rgb(98,98,98)">.</span>Rot3, R_tangent)
<span class="ansi-green-fg">---&gt; 10</span> <span class="ansi-bold" style="color: rgb(0,135,0)">assert</span> R_reconstruct_ <span style="color: rgb(98,98,98)">==</span> R_reconstruct

<span class="ansi-red-fg">AssertionError</span>: </pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Lie Group Ops, retract: R_perturbed = R * delta_R, local_coordinates: delta_R = R.inv() * R_perturbed</span>

<span class="c1"># Retract perturbs the given element in the tangent space and returns the updated element</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_yaw_pitch_roll</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">R_tangent_delta</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">R_perturbed</span> <span class="o">=</span> <span class="n">LieGroupOps</span><span class="o">.</span><span class="n">retract</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R_tangent_delta</span><span class="p">)</span>
<span class="c1"># Local coordinates compute the tangent space perturbation between one element and another</span>
<span class="n">R_tangent_delta_reconstruct</span> <span class="o">=</span> <span class="n">LieGroupOps</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">R_perturbed</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_tangent_delta</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_tangent_delta_reconstruct</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Geo-Package-Ops-Operations">
    Geo Package Ops Operations
    <a class="anchor-link" href="#Geo-Package-Ops-Operations">
     ¶
    </a>
   </h3>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Geo-Storage-Operations">
    Geo Storage Operations
    <a class="anchor-link" href="#Geo-Storage-Operations">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Geo Storage Operations</span>
<span class="n">rot</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="p">()</span>
<span class="n">elements</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">to_storage</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Symbolic to_storage test:"</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">==</span> <span class="n">rot</span><span class="o">.</span><span class="n">storage_dim</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
<span class="c1"># Construction from scalar list</span>
<span class="n">rot2</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_storage</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">rot</span> <span class="o">==</span> <span class="n">rot2</span>
<span class="c1"># Symbolic operations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Symbolic subs test:"</span><span class="p">)</span>
<span class="n">rot_sym</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"rot_sym"</span><span class="p">)</span>
<span class="n">rot_num</span> <span class="o">=</span> <span class="n">rot_sym</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">rot_sym</span><span class="p">,</span> <span class="n">rot</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">rot_sym</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">rot_num</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">rot_num</span><span class="o">.</span><span class="n">simplify</span><span class="p">())</span>  <span class="c1"># Simplify internal symbolic expressions</span>
<span class="n">display</span><span class="p">(</span><span class="n">rot_num</span><span class="o">.</span><span class="n">evalf</span><span class="p">())</span>  <span class="c1"># Numerical evaluation</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Geo-Group-Operations">
    Geo Group Operations
    <a class="anchor-link" href="#Geo-Group-Operations">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Geo Group Operations</span>
<span class="n">R1</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<span class="n">R2</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

<span class="c1"># Composition</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Composition test:"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">R2</span><span class="p">))</span>  <span class="c1"># For rotations this is the same as R1 * R2</span>
<span class="c1"># Identity</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Identity test:"</span><span class="p">)</span>
<span class="n">R_identity</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_identity</span> <span class="o">*</span> <span class="n">R1</span><span class="p">)</span>
<span class="c1"># Inverse</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Inverse test:"</span><span class="p">)</span>
<span class="n">R1_inv</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_identity</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R1_inv</span> <span class="o">*</span> <span class="n">R1</span><span class="p">)</span>
<span class="c1"># Between</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Between test:"</span><span class="p">)</span>
<span class="n">R_delta</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R1</span> <span class="o">*</span> <span class="n">R_delta</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Geo-Tangent-Operations">
    Geo Tangent Operations
    <a class="anchor-link" href="#Geo-Tangent-Operations">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Geo Tangent Operations</span>
<span class="c1"># To/From tangent space vector about identity element</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"To/From tangent space vector test:"</span><span class="p">)</span>
<span class="n">R1</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
<span class="n">tangent_vec</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">to_tangent</span><span class="p">()</span>
<span class="n">R1_recovered</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_tangent</span><span class="p">(</span><span class="n">tangent_vec</span><span class="p">)</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tangent_vec</span><span class="p">)</span> <span class="o">==</span> <span class="n">R1</span><span class="o">.</span><span class="n">tangent_dim</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">R1_recovered</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Tangent space perturbations test:"</span><span class="p">)</span>
<span class="c1"># Tangent space perturbations</span>
<span class="c1"># Perturb R1 by the given vector in the tangent space around R1</span>
<span class="n">R_perturb_delta</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]</span>
<span class="n">R2</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">retract</span><span class="p">(</span><span class="n">R_perturb_delta</span><span class="p">)</span>

<span class="c1"># Compute the tangent vector pointing from R1 to R2, in the tangent space around R1</span>
<span class="n">recovered_tangent_vec</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">local_coordinates</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span>
<span class="n">recovered_tangent_vec2</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">R2</span><span class="p">)</span><span class="o">.</span><span class="n">to_tangent</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">R_perturb_delta</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">recovered_tangent_vec</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">recovered_tangent_vec2</span><span class="p">)</span>

<span class="n">jacobian</span> <span class="o">=</span> <span class="n">R1</span><span class="o">.</span><span class="n">storage_D_tangent</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">jacobian</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">R1</span><span class="o">.</span><span class="n">storage_dim</span><span class="p">(),</span> <span class="n">R1</span><span class="o">.</span><span class="n">tangent_dim</span><span class="p">())</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Special-SE(n)">
    Special SE(n)
    <a class="anchor-link" href="#Special-SE(n)">
     ¶
    </a>
   </h4>
   <p>
    Perturbation on SE(3) is done separately on SO(3) and R(3).
   </p>
   <pre><code>Pose3(R=self.R.retract(vec[:3], epsilon=epsilon),
t=ops.LieGroupOps.retract(self.t, vec[3:], epsilon=epsilon))
</code></pre>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># SE(n)</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="n">T_tangent_delta</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
<span class="n">T_perturb</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">retract</span><span class="p">(</span><span class="n">T_tangent_delta</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">T_perturb</span><span class="p">)</span>
<span class="n">T_perturb_reconstruct</span> <span class="o">=</span>  <span class="n">T</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">from_tangent</span><span class="p">(</span><span class="n">T_tangent_delta</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">T_perturb_reconstruct</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">T_perturb_reconstruct</span> <span class="o">!=</span> <span class="n">T_perturb</span> <span class="c1"># This is expected since SE(3) is modeled as SO(3) + R(3)</span>
<span class="n">T_perturb_reconstruct</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">rotation</span><span class="p">()</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">Rot3</span><span class="o">.</span><span class="n">from_tangent</span><span class="p">(</span><span class="n">T_tangent_delta</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])),</span> 
                                             <span class="n">T</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">(</span><span class="n">T_tangent_delta</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
<span class="k">assert</span> <span class="n">T_perturb_reconstruct</span> <span class="o">==</span> <span class="n">T_perturb</span>
<span class="n">display</span><span class="p">(</span><span class="n">T_perturb_reconstruct</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Code-Generation">
    Code Generation
    <a class="anchor-link" href="#Code-Generation">
     ¶
    </a>
   </h3>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Setup</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">symforce</span>

<span class="kn">from</span> <span class="nn">symforce</span> <span class="kn">import</span> <span class="n">codegen</span>
<span class="kn">from</span> <span class="nn">symforce.codegen</span> <span class="kn">import</span> <span class="n">codegen_util</span>
<span class="kn">from</span> <span class="nn">symforce</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
<span class="kn">from</span> <span class="nn">symforce.values</span> <span class="kn">import</span> <span class="n">Values</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">display_code</span><span class="p">,</span> <span class="n">display_code_file</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Code-generation-using-implicit-functions-with-Values-objects">
    Code generation using implicit functions with Values objects
    <a class="anchor-link" href="#Code-generation-using-implicit-functions-with-Values-objects">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Generate functions</span>
<span class="kn">from</span> <span class="nn">symforce.values</span> <span class="kn">import</span> <span class="n">Values</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="n">w_T_b</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"T"</span><span class="p">),</span>
    <span class="n">b_t_p</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"p"</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">namespace</span> <span class="o">=</span> <span class="s2">"my_sym"</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">Values</span><span class="p">()</span>
<span class="n">outputs</span><span class="p">[</span><span class="s2">"w_t_p"</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">"w_T_b"</span><span class="p">]</span> <span class="o">*</span> <span class="n">inputs</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">b_t_p</span>

<span class="n">input_values</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>
<span class="n">output_values</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span><span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>
<span class="n">point_projection_condegen</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">Codegen</span><span class="p">(</span>
    <span class="n">inputs</span><span class="o">=</span><span class="n">input_values</span><span class="p">,</span>
    <span class="n">outputs</span><span class="o">=</span><span class="n">output_values</span><span class="p">,</span>
    <span class="n">config</span><span class="o">=</span><span class="n">codegen</span><span class="o">.</span><span class="n">CppConfig</span><span class="p">(),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"point_projection"</span><span class="p">,</span>
    <span class="c1">#  If specified, the output with this key is returned rather than filled in as a named output argument</span>
    <span class="n">return_key</span><span class="o">=</span><span class="s2">"outputs"</span>
<span class="p">)</span>

<span class="n">point_projection_condegen_data</span> <span class="o">=</span> <span class="n">point_projection_condegen</span><span class="o">.</span><span class="n">generate_function</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">)</span>

<span class="c1"># Print what we generated</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Files generated in </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">point_projection_condegen_data</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">point_projection_condegen_data</span><span class="o">.</span><span class="n">generated_files</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  |- </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">point_projection_condegen_data</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)))</span>
<span class="n">display_code_file</span><span class="p">(</span><span class="n">point_projection_condegen_data</span><span class="o">.</span><span class="n">function_dir</span> <span class="o">/</span> <span class="s2">"point_projection.h"</span><span class="p">,</span> <span class="s2">"C++"</span><span class="p">)</span>
<span class="c1"># display_code_file(point_projection_condegen_data.cpp_types_dir / namespace / "inputs_t.hpp", "C++")</span>
<span class="c1"># display_code_file(point_projection_condegen_data.cpp_types_dir / namespace / "outputs_t.hpp", "C++")</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Code-generation-using-python-functions">
    Code generation using python functions
    <a class="anchor-link" href="#Code-generation-using-python-functions">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Generate functions</span>
<span class="k">def</span> <span class="nf">transform_point</span><span class="p">(</span><span class="n">w_T_b</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> <span class="n">b_t_p</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Transform a point from body frame into world frame.</span>

<span class="sd">    Args:</span>
<span class="sd">        w_T_b (sf.Pose3): camera pose in the world</span>
<span class="sd">        b_t_p (sf.V3): point in body frame</span>
<span class="sd">        epsilon (Scalar): small number to avoid singularities, not used...</span>

<span class="sd">    Returns:</span>
<span class="sd">        sf.V3: (x, y, z)</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">w_T_b</span> <span class="o">*</span> <span class="n">b_t_p</span>

<span class="n">my_codegen</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">Codegen</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="n">transform_point</span><span class="p">,</span>
    <span class="c1"># config=codegen.PythonConfig(),</span>
    <span class="n">config</span><span class="o">=</span><span class="n">codegen</span><span class="o">.</span><span class="n">CppConfig</span><span class="p">(),</span>
<span class="p">)</span>
<span class="n">my_codegen_data</span> <span class="o">=</span> <span class="n">my_codegen</span><span class="o">.</span><span class="n">generate_function</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Files generated in </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_codegen_data</span><span class="o">.</span><span class="n">output_dir</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">my_codegen_data</span><span class="o">.</span><span class="n">generated_files</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  |- </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">my_codegen_data</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)))</span>

<span class="n">display_code_file</span><span class="p">(</span><span class="n">my_codegen_data</span><span class="o">.</span><span class="n">generated_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"C++"</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Generate jacobian function</span>
<span class="k">def</span> <span class="nf">transform_point</span><span class="p">(</span><span class="n">w_T_b</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> <span class="n">b_t_p</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Transform a point from body frame into world frame.</span>

<span class="sd">    Args:</span>
<span class="sd">        w_T_b (sf.Pose3): camera pose in the world</span>
<span class="sd">        b_t_p (sf.V3): point in body frame</span>
<span class="sd">        epsilon (Scalar): small number to avoid singularities, not used...</span>

<span class="sd">    Returns:</span>
<span class="sd">        sf.Pose3: w_Trans_b</span>
<span class="sd">        sf.V3: b_t_point</span>
<span class="sd">        sf.V3: w_t_point</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">w_T_b</span><span class="p">,</span> <span class="n">b_t_p</span><span class="p">,</span> <span class="n">w_T_b</span> <span class="o">*</span> <span class="n">b_t_p</span>

<span class="n">my_codegen</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">Codegen</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="n">transform_point</span><span class="p">,</span>
    <span class="c1"># config=codegen.PythonConfig(),</span>
    <span class="n">config</span><span class="o">=</span><span class="n">codegen</span><span class="o">.</span><span class="n">CppConfig</span><span class="p">(),</span>
    <span class="n">input_types</span><span class="o">=</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span><span class="p">],</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"my_transform_point"</span><span class="p">,</span>
    <span class="c1"># We have three outputs</span>
    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"w_Trans_b"</span><span class="p">,</span> <span class="s2">"point_t_b"</span><span class="p">,</span> <span class="s2">"point_t_w"</span><span class="p">],</span>
    <span class="c1"># Function returns point_t_w</span>
    <span class="n">return_key</span><span class="o">=</span><span class="s2">"point_t_w"</span>
<span class="p">)</span>

<span class="n">codegen_with_jacobians</span> <span class="o">=</span> <span class="n">my_codegen</span><span class="o">.</span><span class="n">with_jacobians</span><span class="p">(</span>
    <span class="c1"># Just compute wrt the pose and point, not epsilon</span>
    <span class="c1"># Note the function name has a suffix 01 because it calculates jacobian wrt. the first and second inputs</span>
    <span class="n">which_args</span><span class="o">=</span><span class="p">[</span><span class="s2">"w_T_b"</span><span class="p">,</span> <span class="s2">"b_t_p"</span><span class="p">],</span>
    <span class="c1"># We only want to calculate jacobian for `point_t_b` and `point_t_w`</span>
    <span class="n">which_results</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="c1"># Include value, not just jacobians</span>
    <span class="n">include_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># sparse_jacobians=True,</span>
    <span class="c1"># name="MyUselessJaccobians"</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">codegen_with_jacobians</span><span class="o">.</span><span class="n">generate_function</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display_code_file</span>

<span class="n">display_code_file</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">generated_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"C++"</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area collapsed">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Generate with_linearization function with only 1 output</span>
<span class="k">def</span> <span class="nf">transform_point</span><span class="p">(</span><span class="n">w_T_b</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> <span class="n">b_t_p</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Transform a point from body frame into world frame.</span>

<span class="sd">    Args:</span>
<span class="sd">        w_T_b (sf.Pose3): camera pose in the world</span>
<span class="sd">        b_t_p (sf.V3): point in body frame</span>
<span class="sd">        epsilon (Scalar): small number to avoid singularities, not used...</span>

<span class="sd">    Returns:</span>
<span class="sd">        sf.V3: w_t_point</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">w_T_b</span> <span class="o">*</span> <span class="n">b_t_p</span>

<span class="n">my_codegen</span> <span class="o">=</span> <span class="n">codegen</span><span class="o">.</span><span class="n">Codegen</span><span class="o">.</span><span class="n">function</span><span class="p">(</span>
    <span class="n">func</span><span class="o">=</span><span class="n">transform_point</span><span class="p">,</span>
    <span class="c1"># config=codegen.PythonConfig(),</span>
    <span class="n">config</span><span class="o">=</span><span class="n">codegen</span><span class="o">.</span><span class="n">CppConfig</span><span class="p">(),</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">"my_transform_point"</span><span class="p">,</span>
    <span class="c1"># We have only 1 output</span>
    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s2">"point_t_w"</span><span class="p">],</span>
    <span class="c1"># Function returns point_t_w</span>
    <span class="n">return_key</span><span class="o">=</span><span class="s2">"point_t_w"</span>
<span class="p">)</span>

<span class="n">codegen_with_jacobians</span> <span class="o">=</span> <span class="n">my_codegen</span><span class="o">.</span><span class="n">with_linearization</span><span class="p">(</span>
    <span class="c1"># Just compute wrt the pose and point, not epsilon</span>
    <span class="c1"># Note the function name has a suffix 01 because it calculates jacobian wrt. the first and second inputs</span>
    <span class="n">which_args</span><span class="o">=</span><span class="p">[</span><span class="s2">"w_T_b"</span><span class="p">],</span>
    <span class="c1"># Include value, not just jacobians</span>
    <span class="n">include_result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1">#linearization_mode=codegen.LinearizationMode.STACKED_JACOBIAN</span>
    <span class="c1"># Generate jacobian, hession and rhs for Gauss Netwon</span>
    <span class="n">linearization_mode</span><span class="o">=</span><span class="n">codegen</span><span class="o">.</span><span class="n">LinearizationMode</span><span class="o">.</span><span class="n">FULL_LINEARIZATION</span><span class="p">,</span>
    <span class="c1"># name="MyUselessJaccobians"</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">codegen_with_jacobians</span><span class="o">.</span><span class="n">generate_function</span><span class="p">()</span>
<span class="kn">from</span> <span class="nn">symforce.notebook_util</span> <span class="kn">import</span> <span class="n">display_code_file</span>

<span class="n">display_code_file</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">generated_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">"C++"</span><span class="p">)</span>
<span class="c1">#</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Optimization">
    Optimization
    <a class="anchor-link" href="#Optimization">
     ¶
    </a>
   </h3>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    Let's walk through solving a simplified
    <a href="https://en.wikipedia.org/wiki/Point-set_registration">
     point cloud registration problem
    </a>
    with Symforce. In this example, we know the correspondences between two point clouds and we would like to find a
    <code>
     sf.Pose3
    </code>
    to align two point clouds.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Symforce-setup">
    Symforce setup
    <a class="anchor-link" href="#Symforce-setup">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    In this example, we will use symbolic variables to define our residual function so we need to import
    <code>
     symforce.symbolic
    </code>
    .
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="kn">import</span> <span class="nn">symforce.symbolic</span> <span class="k">as</span> <span class="nn">sf</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We build up input
    <code>
     Values
    </code>
    using runtime types, e.g.
    <code>
     sym.pose3
    </code>
    ,
    <code>
     np.ndarray
    </code>
    instead of symbolic types.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="kn">from</span> <span class="nn">symforce.values</span> <span class="kn">import</span> <span class="n">Values</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sym</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    For building a factor graph and solve the problem, we need to import
    <code>
     Factor
    </code>
    and
    <code>
     Optimizer
    </code>
    .
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="kn">from</span> <span class="nn">symforce.opt.factor</span> <span class="kn">import</span> <span class="n">Factor</span>
<span class="kn">from</span> <span class="nn">symforce.opt.optimizer</span> <span class="kn">import</span> <span class="n">Optimizer</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    In this example, we will also show the usage of customized cost functions for computing residuals.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="kn">from</span> <span class="nn">symforce.opt.noise_models</span> <span class="kn">import</span> <span class="n">IsotropicNoiseModel</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Set-up-the-problem">
    Set up the problem
    <a class="anchor-link" href="#Set-up-the-problem">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We first generate 30 points in robot body frame.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">num_points</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">points_b</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
    <span class="n">points_b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,)))</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We create a ground truth
    <code>
     w_T_b_GT
    </code>
    , and use it to transform the 30 points in body frame to world frame.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">pose_tangent_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">w_T_b_GT</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">identity</span><span class="p">()</span><span class="o">.</span><span class="n">retract</span><span class="p">(</span><span class="n">pose_tangent_delta</span><span class="p">)</span>
<span class="n">points_w</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
    <span class="n">points_w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_T_b_GT</span> <span class="o">*</span> <span class="n">points_b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Build-an-optimization-problem">
    Build an optimization problem
    <a class="anchor-link" href="#Build-an-optimization-problem">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We define a simple residual function which simply calculates the difference between two corresponded points in the aligned point clouds. Note that we apply a
    <code>
     IsotropicNoiseModel
    </code>
    to whiten the residual. It doesn't really affect the optimization results but you can see the final total error is scaled by the
    <code>
     sigma
    </code>
    .
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="k">def</span> <span class="nf">projection_residual</span><span class="p">(</span><span class="n">w_T_b</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Pose3</span><span class="p">,</span> <span class="n">b_t_p</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span> <span class="n">w_t_p</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="n">sf</span><span class="o">.</span><span class="n">Scalar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="p">:</span>
    <span class="n">noise_model</span> <span class="o">=</span> <span class="n">IsotropicNoiseModel</span><span class="o">.</span><span class="n">from_sigma</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">noise_model</span><span class="o">.</span><span class="n">whiten</span><span class="p">(</span><span class="n">w_T_b</span><span class="o">*</span><span class="n">b_t_p</span> <span class="o">-</span> <span class="n">w_t_p</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We build up the inputs to the optimization problem using symforce runtime types. Note that the initial pose value is
    <code>
     sym.Pose3.identity()
    </code>
    which is different from
    <code>
     w_T_b_GT
    </code>
    . We hope the optimizer can give us a solution very close to
    <code>
     w_T_b_GT
    </code>
    .
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="n">Values</span><span class="p">(</span>
    <span class="n">w_T_b</span><span class="o">=</span><span class="n">sym</span><span class="o">.</span><span class="n">Pose3</span><span class="o">.</span><span class="n">identity</span><span class="p">(),</span>
    <span class="n">points_b</span><span class="o">=</span><span class="n">points_b</span><span class="p">,</span>
    <span class="n">points_w</span><span class="o">=</span><span class="n">points_w</span><span class="p">,</span>
    <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
<span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    Create
    <code>
     Factor
    </code>
    s  from the residual functions and a set of keys.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
    <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Factor</span><span class="p">(</span>
            <span class="n">residual</span><span class="o">=</span><span class="n">projection_residual</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s2">"w_T_b"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"points_b[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]"</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"points_w[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]"</span><span class="p">,</span> <span class="s2">"sigma"</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Solve-the-optimization-problem">
    Solve the optimization problem
    <a class="anchor-link" href="#Solve-the-optimization-problem">
     ¶
    </a>
   </h4>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We create an Optimizer with factors and tell it to only optimize the pose key (the rest are held constant). Here we show lots of configure parameters for the optimizer you can tune.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="p">(</span>
    <span class="n">factors</span><span class="o">=</span><span class="n">factors</span><span class="p">,</span>
    <span class="n">optimized_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">"w_T_b"</span><span class="p">],</span>
    <span class="n">debug_stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="n">Optimizer</span><span class="o">.</span><span class="n">Params</span><span class="p">(</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">initial_lambda</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">lambda_up_factor</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="n">lambda_down_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="n">lambda_lower_bound</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">lambda_upper_bound</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">,</span>
        <span class="n">use_diagonal_damping</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">use_unit_damping</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_max_diagonal_damping</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">diagonal_damping_min</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">early_exit_min_reduction</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">enable_bold_updates</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    Run the optimization! This returns an
    <code>
     Optimizer.Result
    </code>
    object that contains the optimized values and many other things.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We can print out the pose before and after the optimization and compare it against our
    <code>
     w_T_b_GT
    </code>
    .
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Early exist? : </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">early_exited</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"w_T_b_GT: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">w_T_b_GT</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Initial w_T_b: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">initial_values</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">w_T_b</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Optimized w_T_b: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">optimized_values</span><span class="o">.</span><span class="n">attr</span><span class="o">.</span><span class="n">w_T_b</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <p>
    We can also print out the total error before and after optimization. Try to change the
    <code>
     sigma
    </code>
    to see how it will change the error value.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="n">initial_linearization</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">linearize</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">initial_values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Initial error: </span><span class="si">{</span><span class="n">initial_linearization</span><span class="o">.</span><span class="n">error</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">optimized_linearization</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">linearize</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">optimized_values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Final error: </span><span class="si">{</span><span class="n">optimized_linearization</span><span class="o">.</span><span class="n">error</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h3 id="Cameras">
    Cameras
    <a class="anchor-link" href="#Cameras">
     ¶
    </a>
   </h3>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h4 id="Camera-Calibrations">
    Camera Calibrations
    <a class="anchor-link" href="#Camera-Calibrations">
     ¶
    </a>
   </h4>
   <p>
    Symforce implements several different calibration models, such as linear model(
    <code>
     LinearCameraCal
    </code>
    ), polynomial model(
    <code>
     PolynomialCameraCal
    </code>
    ), Kannala-Brandt camera model(
    <code>
     SphericalCameraCal
    </code>
    ), etc. They basically contains 1) linear model + distortion coeffs 2) projection and un-projection methods could be used by Camera class.
   </p>
  </div>
 </div>
</div>
<div class="cell border-box-sizing code_cell rendered">
 <div class="input">
  <div class="prompt input_prompt">
   In [ ]:
  </div>
  <div class="inner_cell">
   <div class="input_area">
    <div class="collapse_expand_button fa fa-1x fa-minus-square-o">
    </div>
    <div class="highlight hl-ipython3">
     <pre><span></span><span class="c1"># Linear model</span>

<span class="n">linear_camera_cal</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">LinearCameraCal</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"cal"</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">linear_camera_cal</span><span class="p">)</span>

<span class="n">camera_pixel</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V2</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"uv"</span><span class="p">)</span>
<span class="n">camera_ray</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">linear_camera_cal</span><span class="o">.</span><span class="n">camera_ray_from_pixel</span><span class="p">(</span><span class="n">camera_pixel</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"camera_ray_from_pixel: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">camera_ray</span><span class="p">)</span>
<span class="c1">#print(f"Is valid? {valid == 1}")</span>

<span class="n">camera_point</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">V3</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="s2">"p"</span><span class="p">)</span>
<span class="n">camera_point_reprojected</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">linear_camera_cal</span><span class="o">.</span><span class="n">pixel_from_camera_point</span><span class="p">(</span>
    <span class="n">camera_point</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"pixel_from_camera_point: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">camera_point_reprojected</span><span class="p">)</span>

<span class="c1"># Jacobians</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Jacobians: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">camera_point_reprojected</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">linear_camera_cal</span><span class="o">.</span><span class="n">focal_length</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">camera_point_reprojected</span><span class="o">.</span><span class="n">jacobian</span><span class="p">(</span><span class="n">linear_camera_cal</span><span class="o">.</span><span class="n">principal_point</span><span class="p">))</span>


<span class="n">linear_camera_cal_num</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">LinearCameraCal</span><span class="p">(</span>
    <span class="n">focal_length</span><span class="o">=</span><span class="p">(</span><span class="mi">440</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span>
    <span class="n">principal_point</span><span class="o">=</span><span class="p">(</span><span class="mi">320</span><span class="p">,</span> <span class="mi">240</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Numerical substitution for fun...</span>
<span class="n">linear_camera_cal</span> <span class="o">=</span> <span class="n">linear_camera_cal</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">linear_camera_cal</span><span class="p">,</span> <span class="n">linear_camera_cal_num</span><span class="p">)</span>

<span class="n">linear_camera</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">Camera</span><span class="p">(</span>
    <span class="n">calibration</span><span class="o">=</span><span class="n">linear_camera_cal</span><span class="p">,</span>
    <span class="n">image_size</span><span class="o">=</span><span class="p">(</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">),</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Linear Camera: "</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">linear_camera</span><span class="p">)</span>
</pre>
    </div>
   </div>
  </div>
 </div>
</div>
<div class="cell border-box-sizing text_cell rendered">
 <div class="prompt input_prompt">
 </div>
 <div class="inner_cell">
  <div class="text_cell_render border-box-sizing rendered_html">
   <h2 id="Solve-Problems-in-Real-World">
    Solve Problems in Real World
    <a class="anchor-link" href="#Solve-Problems-in-Real-World">
     ¶
    </a>
   </h2>
  </div>
 </div>
</div>

<div> This blog is converted from <a href="https://github.com/xipengwang/xipengwang.github.io/tree/master/notebooks/symforce.ipynb">symforce.ipynb</a></div>